---
/**
 * ShopPasswordGate - Password protection overlay for the shop
 * 
 * Usage: Wrap shop content with this component
 * Shows centered password input when protection is enabled
 */

interface Props {
  needsPassword: boolean;
  hint?: string | null;
}

const { needsPassword, hint } = Astro.props;
---

{needsPassword ? (
  <div class="shop-password-overlay">
    <div class="shop-password-modal">
      <div class="shop-password-content">
        <h1 class="shop-password-title">Shop Access</h1>
        <p class="shop-password-subtitle">This shop is currently password protected</p>
        
        {hint && (
          <p class="shop-password-hint">{hint}</p>
        )}
        
        <form id="shopPasswordForm" class="shop-password-form">
          <div class="shop-password-input-wrapper">
            <input 
              type="password" 
              id="shopPasswordInput"
              name="password"
              placeholder="Enter password"
              class="shop-password-input"
              required
              autocomplete="off"
            />
          </div>
          
          <button type="submit" class="shop-password-submit">
            Enter Shop
          </button>
        </form>
        
        <p id="shopPasswordError" class="shop-password-error hidden">
          Incorrect password. Please try again.
        </p>
      </div>
    </div>
  </div>
) : (
  <slot />
)}

<style>
  .shop-password-overlay {
    position: fixed;
    inset: 0;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .shop-password-modal {
    width: 100%;
    max-width: 400px;
    padding: 2rem;
  }

  .shop-password-content {
    text-align: center;
  }

  .shop-password-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.5rem;
    color: #111;
  }

  .shop-password-subtitle {
    font-size: 0.9375rem;
    color: #666;
    margin: 0 0 1.5rem;
  }

  .shop-password-hint {
    font-size: 0.875rem;
    color: #888;
    margin: 0 0 1.5rem;
    padding: 0.75rem;
    background: #f5f5f5;
    border-radius: 4px;
  }

  .shop-password-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .shop-password-input-wrapper {
    position: relative;
  }

  .shop-password-input {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    transition: border-color 0.15s ease;
    text-align: center;
    letter-spacing: 0.1em;
  }

  .shop-password-input:focus {
    outline: none;
    border-color: #111;
  }

  .shop-password-input::placeholder {
    letter-spacing: normal;
    color: #999;
  }

  .shop-password-submit {
    width: 100%;
    padding: 0.875rem 1.5rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #fff;
    background: #111;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .shop-password-submit:hover {
    background: #333;
  }

  .shop-password-error {
    margin: 1rem 0 0;
    font-size: 0.875rem;
    color: #e53e3e;
  }

  .hidden {
    display: none !important;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .shop-password-modal {
      padding: 1.5rem;
    }
    
    .shop-password-title {
      font-size: 1.25rem;
    }
  }
</style>

{needsPassword && (
  <script>
    const form = document.getElementById('shopPasswordForm') as HTMLFormElement;
    const input = document.getElementById('shopPasswordInput') as HTMLInputElement;
    const error = document.getElementById('shopPasswordError') as HTMLParagraphElement;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      error.classList.add('hidden');
      
      const password = input.value.trim();
      if (!password) return;

      try {
        const response = await fetch('/api/shop/password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        });

        if (response.ok) {
          // Reload to show shop content (cookie will be set)
          window.location.reload();
        } else {
          error.classList.remove('hidden');
          input.value = '';
          input.focus();
        }
      } catch {
        error.classList.remove('hidden');
        error.textContent = 'Something went wrong. Please try again.';
      }
    });

    // Auto-focus input on load
    input.focus();
  </script>
)}
