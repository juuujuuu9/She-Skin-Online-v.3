---
/**
 * Reset Password Page
 */

export const prerender = false;

import Layout from '@layouts/Layout.astro';

const token = Astro.url.searchParams.get('token');

if (!token) {
  return Astro.redirect('/admin/forgot-password');
}

let message = '';
let error = '';
let success = false;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const newPassword = formData.get('password')?.toString() || '';
    const confirmPassword = formData.get('confirmPassword')?.toString() || '';

    if (newPassword !== confirmPassword) {
      error = 'Passwords do not match';
    } else if (newPassword.length < 6) {
      error = 'Password must be at least 6 characters';
    } else {
      const response = await fetch(new URL('/api/admin/reset-password', Astro.url), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword }),
      });

      const result = await response.json();
      
      if (result.success) {
        success = true;
        message = result.message;
      } else {
        error = result.error || 'Failed to reset password';
      }
    }
  } catch (e) {
    error = 'An error occurred. Please try again.';
  }
}
---

<Layout title="Reset Password - she_skin Admin" hideHeader={true}>
  <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Reset Password
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
          Enter your new password
        </p>
      </div>

      {success ? (
        <div class="rounded-md bg-green-50 p-4">
          <div class="flex">
            <div class="ml-3">
              <p class="text-sm font-medium text-green-800">{message}</p>
            </div>
          </div>
        </div>
        <div class="text-center">
          <a
            href="/admin/login"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800"
          >
            Go to Login
          </a>
        </div>
      ) : (
        <>
          {error && (
            <div class="rounded-md bg-red-50 p-4">
              <p class="text-sm text-red-800">{error}</p>
            </div>
          )}

          <form class="mt-8 space-y-6" method="POST" data-astro-reload>
            <div class="space-y-4">
              <div>
                <label for="password" class="sr-only">New Password</label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  required
                  minlength="6"
                  class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-black focus:border-black focus:z-10 sm:text-sm"
                  placeholder="New password (min 6 characters)"
                />
              </div>
              <div>
                <label for="confirmPassword" class="sr-only">Confirm Password</label>
                <input
                  id="confirmPassword"
                  name="confirmPassword"
                  type="password"
                  required
                  minlength="6"
                  class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-black focus:border-black focus:z-10 sm:text-sm"
                  placeholder="Confirm new password"
                />
              </div>
            </div>

            <div>
              <button
                type="submit"
                class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors"
              >
                Reset Password
              </button>
            </div>
          </form>

          <div class="text-center">
            <a href="/admin/login" class="text-sm text-gray-600 hover:text-gray-900">
              ‚Üê Back to login
            </a>
          </div>
        </>
      )}
    </div>
  </div>
</Layout>
