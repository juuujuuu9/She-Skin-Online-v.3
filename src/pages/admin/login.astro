---
/**
 * Admin Login — Clerk authentication
 */

export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { SignIn } from '@clerk/astro/react';

// Check if user is already signed in server-side
const clerkAuth = Astro.locals.auth();
const isSignedIn = !!clerkAuth.userId;
---

<Layout title="Admin Login - she_skin">
  <div class="min-h-screen bg-[var(--admin-bg-secondary)] flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-[var(--admin-text-primary)]">she_skin Admin</h2>
        <p class="mt-2 text-[var(--admin-text-muted)]">Media Management Dashboard</p>
      </div>

      {isSignedIn ? (
        <!-- User is already signed in - show options -->
        <div class="bg-[var(--admin-bg-tertiary)] border border-[var(--admin-border-primary)] rounded-xl p-6 text-center">
          <p class="text-[var(--admin-text-secondary)] mb-4">You are already signed in.</p>
          <div class="flex flex-col gap-3">
            <a
              href="/admin"
              class="w-full bg-[var(--admin-accent-primary)] hover:bg-[var(--admin-accent-primary-hover)] text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
            >
              Go to Admin Dashboard
            </a>
            <button
              id="login-page-logout-btn"
              type="button"
              class="w-full border border-[var(--admin-border-secondary)] hover:bg-[var(--admin-bg-hover)] text-[var(--admin-text-secondary)] px-4 py-2 rounded-md text-sm font-medium transition-colors"
            >
              Sign Out
            </button>
          </div>
        </div>
      ) : (
        <!-- Show sign in form with loading state -->
        <div class="bg-[var(--admin-bg-tertiary)] border border-[var(--admin-border-primary)] rounded-xl p-6">
          <!-- Loading skeleton shown while Clerk initializes -->
          <div id="clerk-loading" class="space-y-4">
            <div class="h-8 bg-[var(--admin-bg-card)] rounded animate-pulse"></div>
            <div class="h-12 bg-[var(--admin-bg-card)] rounded animate-pulse"></div>
            <div class="h-12 bg-[var(--admin-bg-card)] rounded animate-pulse"></div>
            <div class="h-10 bg-[var(--admin-accent-primary)]/30 rounded animate-pulse"></div>
          </div>
          <div id="clerk-signin-container" class="hidden">
            <!-- Use client:only to prevent hydration issues -->
            <SignIn
              client:only="react"
              routing="path"
              path="/admin/login"
              fallbackRedirectUrl="/admin"
              appearance={{
                elements: {
                  formButtonPrimary: 'bg-[var(--admin-accent-primary)] hover:bg-[var(--admin-accent-primary-hover)] text-white',
                  card: 'bg-transparent shadow-none',
                  headerTitle: 'text-[var(--admin-text-primary)]',
                  headerSubtitle: 'text-[var(--admin-text-tertiary)]',
                  formFieldLabel: 'text-[var(--admin-text-secondary)]',
                  formFieldInput: 'bg-[var(--admin-bg-card)] border-[var(--admin-border-secondary)] text-[var(--admin-text-primary)] rounded-md',
                  footerActionLink: 'text-[var(--admin-accent-primary)] hover:opacity-80',
                  identityPreview: 'bg-[var(--admin-bg-card)] border-[var(--admin-border-secondary)] text-[var(--admin-text-primary)]',
                  alert: 'bg-[var(--admin-accent-danger)]/10 border-[var(--admin-accent-danger)]/20 text-[var(--admin-accent-danger)]',
                }
              }}
            />
          </div>
          <!-- Error message container -->
          <div id="clerk-error" class="hidden mt-4 p-4 bg-[var(--admin-accent-danger)]/10 border border-[var(--admin-accent-danger)]/20 rounded-md">
            <p class="text-[var(--admin-accent-danger)] text-sm">Failed to load login form. Please refresh the page or try again later.</p>
          </div>
        </div>
      )}

      <div class="text-center mt-6">
        <a href="/" class="text-sm text-[var(--admin-text-muted)] hover:text-[var(--admin-text-secondary)] transition-colors">
          ← Back to site
        </a>
      </div>
    </div>
  </div>

  <script>
    // Handle logout button on login page (for already-signed-in users)
    document.getElementById('login-page-logout-btn')?.addEventListener('click', async () => {
      const btn = document.getElementById('login-page-logout-btn') as HTMLButtonElement | null;
      if (btn) {
        btn.textContent = 'Signing out...';
        btn.disabled = true;
      }

      try {
        if (typeof window.Clerk !== 'undefined') {
          await window.Clerk.signOut();
          // Reload the page to show the sign-in form
          window.location.reload();
        }
      } catch (err) {
        console.error('Sign out error:', err);
        window.location.reload();
      }
    });

    // Show Clerk sign-in when it loads, hide loading skeleton
    const loadingEl = document.getElementById('clerk-loading');
    const signinContainer = document.getElementById('clerk-signin-container');
    const errorEl = document.getElementById('clerk-error');

    let checkCount = 0;
    const maxChecks = 150; // 15 seconds max (client:only takes longer to hydrate)

    function checkClerkLoaded() {
      checkCount++;

      // Check if Clerk is available on window
      if (typeof window.Clerk === 'undefined') {
        if (checkCount >= maxChecks) {
          console.error('Clerk SDK not loaded after 15 seconds');
          loadingEl?.classList.add('hidden');
          errorEl?.classList.remove('hidden');
          return;
        }
        setTimeout(checkClerkLoaded, 100);
        return;
      }

      // Clerk adds elements to the DOM when loaded
      const clerkForm = document.querySelector('.cl-rootBox, .cl-card, [data-clerk-component]');
      if (clerkForm && signinContainer) {
        signinContainer.classList.remove('hidden');
        loadingEl?.remove();
        return;
      }

      // Check if we've exceeded max attempts
      if (checkCount >= maxChecks) {
        console.error('Clerk form failed to render after 15 seconds');
        loadingEl?.classList.add('hidden');
        errorEl?.classList.remove('hidden');
        return;
      }

      // Check again in 100ms
      setTimeout(checkClerkLoaded, 100);
    }

    // Start checking for Clerk load
    if (signinContainer) {
      // Delay initial check to allow client:only component to hydrate
      setTimeout(checkClerkLoaded, 1000);
    }
  </script>
</Layout>
