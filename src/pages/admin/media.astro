---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { listMedia } from '@lib/upload-service';
import MediaManager from '@components/admin/MediaManager';

// Load initial media from database
const { media: initialMedia, total } = await listMedia({ limit: 50 });
---

<Layout title="Media Library - she_skin Admin">
  <div class="h-dvh bg-[#0a0a0a] flex flex-col overflow-hidden">
    <div class="flex flex-row flex-1 min-h-0 items-stretch">
      {/* Admin sidebar */}
      <aside class="w-64 shrink-0 flex flex-col bg-[#0a0a0a] text-white self-stretch border-r border-white/10">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
          <a href="/admin" class="text-lg font-bold tracking-tight text-white hover:text-white/90">
            she_skin
          </a>
          <span class="text-xs text-gray-500 uppercase tracking-wider">admin</span>
        </div>

        <nav class="flex-1 p-3 min-h-0 overflow-auto">
          <ul class="space-y-0.5">
            {adminNavItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  class={`
                    flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium transition-colors
                    ${isActive(item.href) ? 'bg-white text-black' : 'text-white/80 hover:bg-white/10 hover:text-white'}
                  `}
                >
                  <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={iconPaths[item.icon] ?? ''} />
                  <span>{item.label}</span>
                </a>
              </li>
            ))}
          </ul>
        </nav>

        <div class="mx-3 border-t border-white/10" />
        
        <nav class="p-3">
          <ul class="space-y-0.5">
            <li>
              <a
                href="/"
                class="flex items-center gap-3 px-3 py-2.5 rounded-md text-sm text-white/60 hover:bg-white/10 hover:text-white transition-colors"
              >
                <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>View Site</span>
              </a>
            </li>
            <li>
              <a
                href="/admin/logout"
                class="flex items-center gap-3 px-3 py-2.5 rounded-md text-sm text-white/60 hover:bg-red-500/20 hover:text-red-400 transition-colors"
              >
                <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Logout</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      {/* Main content */}
<script>
  // DOM Elements
  const dropzone = document.getElementById('dropzone') as HTMLDivElement;
  const fileInput = document.getElementById('fileInput') as HTMLInputElement;
  const uploadProgress = document.getElementById('uploadProgress') as HTMLDivElement;
  const uploadText = document.getElementById('uploadText') as HTMLSpanElement;
  const uploadFill = document.getElementById('uploadFill') as HTMLDivElement;
  const processSection = document.getElementById('processSection') as HTMLDivElement;
  const processBtn = document.getElementById('processBtn') as HTMLButtonElement;
  const processProgress = document.getElementById('processProgress') as HTMLDivElement;
  const processText = document.getElementById('processText') as HTMLSpanElement;
  const pendingSection = document.getElementById('pendingSection') as HTMLDivElement;
  const resultsArea = document.getElementById('resultsArea') as HTMLDivElement;
  const resultsList = document.getElementById('resultsList') as HTMLDivElement;

  // Drag & Drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e: Event) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
  });

  dropzone.addEventListener('drop', handleDrop, false);
  fileInput.addEventListener('change', handleFiles, false);

  function handleDrop(e: DragEvent) {
    const dt = e.dataTransfer;
    if (!dt) return;
    handleFiles({ target: { files: dt.files } } as unknown as Event);
  }

  async function handleFiles(e: Event) {
    const target = e.target as HTMLInputElement;
    const files = target.files;
    if (!files || files.length === 0) return;

    uploadProgress.classList.remove('hidden');
    
    const results: Array<{ id: string; filename: string; success: boolean }> = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const progress = ((i + 1) / files.length) * 100;
      uploadFill.style.width = `${progress}%`;
      uploadText.textContent = `Uploading "${file.name}" (${i + 1}/${files.length})...`;
      
      try {
        const result = await uploadFile(file);
        results.push({ id: result.id, filename: file.name, success: true });
      } catch (error) {
        alert(`Failed to upload "${file.name}": ${error instanceof Error ? error.message : 'Unknown error'}`);
        results.push({ id: '', filename: file.name, success: false });
      }
    }

    uploadProgress.classList.add('hidden');
    
    // Refresh status
    await refreshStatus();
    
    // Show success message
    const successCount = results.filter(r => r.success).length;
    if (successCount > 0) {
      uploadText.textContent = `${successCount} file(s) uploaded and queued`;
      uploadFill.style.width = '100%';
      uploadProgress.classList.remove('hidden');
      setTimeout(() => {
        uploadProgress.classList.add('hidden');
      }, 3000);
    }
  }

  async function uploadFile(file: File): Promise<{ id: string; type: string; status: string }> {
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('/api/admin/media/upload', {
      method: 'POST',
      body: formData,
      credentials: 'include',
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      const msg = error?.error || 'Upload failed';
      if (response.status === 401) {
        throw new Error('Session expired or not logged in. Please log in again at /admin/login and try again.');
      }
      throw new Error(msg);
    }

    return response.json();
  }

  // Process Button
  processBtn.addEventListener('click', async () => {
    processBtn.disabled = true;
    processProgress.classList.remove('hidden');
    processText.textContent = 'Processing files... This may take a while for long audio.';
    
    try {
      const response = await fetch('/api/admin/media/process-pending', {
        method: 'POST',
        credentials: 'include',
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Processing failed');
      }
      
      processProgress.classList.add('hidden');
      
      if (result.succeeded > 0) {
        displayResults(result.results.filter((r: { success: boolean }) => r.success));
        resultsArea.classList.remove('hidden');
      }
      
      if (result.failed > 0) {
        const failed = result.results.filter((r: { success: boolean }) => !r.success);
        alert(`${result.failed} file(s) failed:\n${failed.map((f: { id: string; error?: string }) => `${f.id}: ${f.error}`).join('\n')}`);
      }
      
      // Refresh the page to show updated media grid
      setTimeout(() => window.location.reload(), 2000);
      
    } catch (error) {
      processProgress.classList.add('hidden');
      processBtn.disabled = false;
      alert(`Processing failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  });

  function displayResults(results: Array<{ id: string }>) {
    resultsList.innerHTML = results.map((r: { id: string }) => `
      <div class="result-item">
        <div class="result-thumb" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          âœ…
        </div>
        <div class="result-info">
          <div class="result-id" data-id="${r.id}">
            ${r.id}
            <span class="copy-icon">ðŸ“‹</span>
          </div>
          <div class="result-meta">
            Ready to use in content
          </div>
        </div>
        <span class="result-status">Processed</span>
      </div>
    `).join('');

    // Add copy handlers
    resultsList.querySelectorAll('.result-id').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-id');
        if (id) {
          navigator.clipboard.writeText(id);
          el.classList.add('copied');
          setTimeout(() => el.classList.remove('copied'), 2000);
        }
      });
    });
  }

  // Refresh status display
  async function refreshStatus() {
    try {
      const response = await fetch('/api/admin/media/process-pending', { credentials: 'include' });
      if (!response.ok) return;
      
      const status = await response.json();
      
      // Update counts
      const pendingEl = document.getElementById('pendingCount');
      const processingEl = document.getElementById('processingCount');
      const errorEl = document.getElementById('errorCount');
      
      if (pendingEl) pendingEl.textContent = status.counts.pending;
      if (processingEl) processingEl.textContent = status.counts.processing;
      if (errorEl) errorEl.textContent = status.counts.error;
      
      // Update button
      const btnText = processBtn.querySelector('.btn-text');
      if (btnText) {
        btnText.textContent = `Process ${status.counts.pending} Pending File${status.counts.pending !== 1 ? 's' : ''}`;
      }
      processBtn.disabled = status.counts.pending === 0;
      processSection.style.opacity = status.counts.pending === 0 ? '0.5' : '1';
      
      // Show/hide pending section
      if (status.counts.pending > 0 || status.counts.error > 0) {
        pendingSection.classList.remove('hidden');
      }
      
    } catch (e) {
      console.error('Failed to refresh status:', e);
    }
  }

  // Copy handlers for existing media
  document.querySelectorAll('.copy-id').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      if (id) {
        navigator.clipboard.writeText(id);
        btn.classList.add('copied');
        const icon = btn.querySelector('.copy-icon');
        if (icon) icon.textContent = 'âœ“';
        setTimeout(() => {
          btn.classList.remove('copied');
          if (icon) icon.textContent = 'ðŸ“‹';
        }, 2000);
      }
    });
  });

  // Poll status every 5 seconds if there are pending/processing items
  const pendingCount = parseInt(document.getElementById('pendingCount')?.textContent || '0');
  const processingCount = parseInt(document.getElementById('processingCount')?.textContent || '0');
  
  if (pendingCount > 0 || processingCount > 0) {
    setInterval(refreshStatus, 5000);
  }
</script>

      <main class="flex-1 min-w-0 bg-gray-900 overflow-y-auto">
        <div class="p-6 max-w-7xl mx-auto">
          <header class="mb-6">
            <h1 class="text-2xl font-semibold text-white">Media Library</h1>
            <p class="text-gray-400 mt-1">Upload, manage, and delete media files. Reference counts show where files are used.</p>
          </header>

  .admin-header h1 {
    font-size: 2rem;
    margin: 0 0 0.5rem;
    color: #fff;
    font-weight: 600;
  }
