---
/**
 * Digital Work â€” New or Edit. Data from database.
 */

export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { checkAdminAuth } from '@lib/admin-auth';
import { getWorkBySlug } from '@lib/db/queries';

const auth = checkAdminAuth(Astro.request);
if (!auth.valid) {
  return Astro.redirect('/admin/login');
}

const { slug } = Astro.params;
const isNew = slug === 'new';

let work: { id: string; slug: string; title: string; year: number; forSale: boolean; image: string } | null = null;
if (!isNew && slug) {
  const dbWork = await getWorkBySlug(slug);
  if (dbWork && dbWork.category === 'digital') {
    const primaryImage = dbWork.media.find((m) => m.isPrimary || m.type === 'image') || dbWork.media[0];
    work = {
      id: dbWork.id,
      slug: dbWork.slug,
      title: dbWork.title,
      year: dbWork.year ?? new Date().getFullYear(),
      forSale: dbWork.forSale ?? false,
      image: primaryImage?.url ?? '',
    };
  }
}
if (!isNew && !work) {
  return Astro.redirect('/admin/digital');
}
---

<Layout title={isNew ? 'New Digital Work - she_skin Admin' : 'Edit Digital Work - she_skin Admin'}>
  <div class="min-h-screen bg-gray-50" x-data="digitalWorkForm()">
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center gap-4">
            <a href="/admin/digital" class="text-gray-600 hover:text-gray-900">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </a>
            <h1 class="text-xl font-bold text-gray-900">{isNew ? 'New Digital Work' : 'Edit Digital Work'}</h1>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/digital" class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Cancel</a>
            <button
              @click="submit()"
              :disabled="!canSubmit || uploading"
              :class="canSubmit && !uploading ? 'bg-black hover:bg-gray-800' : 'bg-gray-400 cursor-not-allowed'"
              class="px-4 py-2 text-sm font-medium text-white rounded-md transition-colors"
            >
              <span x-show="!uploading">{isNew ? 'Add Work' : 'Save'}</span>
              <span x-show="uploading">Uploading...</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Artwork Image</label>
          <div
            x-show="!form.image"
            @dragover.prevent="dragover = true"
            @dragleave.prevent="dragover = false"
            @drop.prevent="handleImageDrop($event)"
            :class="dragover ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
            class="border-2 border-dashed rounded-lg p-8 text-center transition-colors"
          >
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p class="mt-2 text-sm text-gray-600"><span class="font-medium text-blue-600">Click to upload</span> or drag and drop</p>
            <p class="text-xs text-gray-500">WebP, JPG, or PNG</p>
            <input type="file" @change="handleImageSelect($event)" accept="image/*" class="hidden" x-ref="fileInput" />
            <button @click="$refs.fileInput.click()" class="mt-4 px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">Select Image</button>
          </div>
          <div x-show="form.image" class="relative">
            <img :src="form.image" class="w-full max-w-sm aspect-[4/5] object-cover rounded-lg" />
            <button
              @click="form.image = ''; form.imageFile = null"
              class="absolute top-2 right-2 p-2 bg-red-600 text-white rounded-md hover:bg-red-700"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input
              type="text"
              x-model="form.title"
              placeholder="e.g., Digital piece title"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
            <input
              type="number"
              x-model="form.year"
              placeholder="2024"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black"
            />
          </div>
          <div class="flex items-center pt-8">
            <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
              <input type="checkbox" x-model="form.forSale" class="rounded border-gray-300 w-5 h-5" />
              <span class="font-medium">For Sale</span>
            </label>
          </div>
        </div>
      </div>
    </main>

    <div
      x-show="toast.visible"
      x-transition
      class="fixed bottom-4 right-4 px-6 py-3 rounded-md shadow-lg text-white"
      :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'"
    >
      <span x-text="toast.message"></span>
    </div>
  </div>

  <script is:inline define:vars={{ isNew, initialWork: work }}>
    function digitalWorkForm() {
      return {
        isNew,
        initialWork: initialWork || null,
        form: {
          title: initialWork?.title || '',
          year: initialWork?.year || new Date().getFullYear(),
          forSale: initialWork?.forSale || false,
          image: initialWork?.image || '',
          imageFile: null,
        },
        dragover: false,
        uploading: false,
        toast: { visible: false, message: '', type: 'success' },
        get canSubmit() { return this.form.title && this.form.image; },
        handleImageDrop(e) {
          this.dragover = false;
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) this.processImage(file);
        },
        handleImageSelect(e) {
          const file = e.target.files[0];
          if (file) this.processImage(file);
        },
        processImage(file) {
          this.form.imageFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            this.form.image = e.target.result;
            if (!this.form.title) this.form.title = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
          };
          reader.readAsDataURL(file);
        },
        async submit() {
          if (!this.canSubmit) return;
          this.uploading = true;
          try {
            let imageUrl = this.form.image;
            if (this.form.imageFile) {
              const formData = new FormData();
              formData.append('file', this.form.imageFile);
              formData.append('folder', 'digital');
              const res = await fetch('/api/admin/upload', { method: 'POST', body: formData });
              if (!res.ok) throw new Error('Upload failed');
              const data = await res.json();
              imageUrl = data.url;
            }
            const slug = this.form.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-');
            const res = await fetch('/api/admin/digital/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                isNew: this.isNew,
                item: {
                  id: this.initialWork?.id,
                  slug: this.isNew ? slug : this.initialWork?.slug,
                  title: this.form.title,
                  year: parseInt(this.form.year) || new Date().getFullYear(),
                  forSale: this.form.forSale,
                  image: imageUrl,
                },
              }),
            });
            if (!res.ok) throw new Error('Save failed');
            this.showToast(this.isNew ? 'Work added!' : 'Saved!', 'success');
            setTimeout(() => window.location.href = '/admin/digital', 800);
          } catch (err) {
            this.showToast(err?.message || 'Failed', 'error');
          } finally {
            this.uploading = false;
          }
        },
        showToast(message, type) {
          this.toast = { visible: true, message, type };
          setTimeout(() => this.toast.visible = false, 3000);
        },
      };
    }
  </script>
</Layout>
