---
/**
 * Edit Post - Post editor
 */

export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { checkAdminAuth } from '@lib/admin-auth';
import { db } from '@lib/db';
import { posts } from '@lib/db/schema';
import { eq } from 'drizzle-orm';

// Check auth
const auth = await checkAdminAuth(Astro.request);
if (!auth.valid) {
  return Astro.redirect('/admin/login');
}

// Get post ID if editing
const postId = Astro.url.searchParams.get('id');
let post = null;

if (postId) {
  post = await db.query.posts.findFirst({
    where: eq(posts.id, postId),
    with: {
      meta: true,
      media: {
        with: {
          media: true,
        },
      },
    },
  });
}

const isEditing = !!post;
const title = isEditing ? 'Edit Post' : 'New Post';
---

<AdminLayout title={`${title} - she_skin Admin`}>
  <main class="flex-1 min-w-0 bg-[#111] overflow-y-auto">
    {/* Header */}
    <div class="px-6 py-4 border-b border-[#333]">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/admin/posts" class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </a>
          <h1 class="text-2xl font-bold text-white">{title}</h1>
        </div>
        <div class="flex items-center gap-3">
          <button
            type="button"
            id="save-draft-btn"
            class="px-4 py-2 border border-[#444] text-sm font-medium rounded-md text-gray-300 bg-[#1a1a1a] hover:bg-[#222] transition-colors"
          >
            Save Draft
          </button>
          <button
            type="button"
            id="publish-btn"
            class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-black bg-white hover:bg-gray-200 transition-colors"
          >
            {post?.status === 'published' ? 'Update' : 'Publish'}
          </button>
        </div>
      </div>
    </div>

    {/* Editor */}
    <div class="px-6 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Content */}
        <div class="lg:col-span-2 space-y-6">
          {/* Title */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <label for="title" class="block text-sm font-medium text-gray-300 mb-2">
              Title
            </label>
            <input
              type="text"
              id="title"
              value={post?.title || ''}
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-lg font-medium text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
              placeholder="Enter post title..."
            />
          </div>

          {/* Content */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <label for="content" class="block text-sm font-medium text-gray-300 mb-2">
              Content
            </label>
            <textarea
              id="content"
              rows={20}
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md font-mono text-sm text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
              placeholder="Write your content here... (Markdown supported)"
            >{post?.content || ''}</textarea>
            <p class="mt-2 text-xs text-gray-500">
              Markdown is supported. Use **bold**, *italic*, [links](url), etc.
            </p>
          </div>

          {/* Excerpt */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <label for="excerpt" class="block text-sm font-medium text-gray-300 mb-2">
              Excerpt
            </label>
            <textarea
              id="excerpt"
              rows={3}
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
              placeholder="Brief description for listings..."
            >{post?.excerpt || ''}</textarea>
          </div>
        </div>

        {/* Sidebar */}
        <div class="space-y-6">
          {/* Status */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <h3 class="text-sm font-medium text-white mb-4">Status</h3>
            <select
              id="status"
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white focus:ring-2 focus:ring-white/20 focus:border-white/30"
            >
              <option value="draft" selected={post?.status === 'draft'}>Draft</option>
              <option value="published" selected={post?.status === 'published'}>Published</option>
              <option value="scheduled" selected={post?.status === 'scheduled'}>Scheduled</option>
            </select>
          </div>

          {/* Post Type */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <h3 class="text-sm font-medium text-white mb-4">Post Type</h3>
            <select
              id="post-type"
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white focus:ring-2 focus:ring-white/20 focus:border-white/30"
            >
              <option value="page" selected={post?.postType === 'page'}>Page</option>
              <option value="work" selected={post?.postType === 'work'}>Work</option>
              <option value="product_description" selected={post?.postType === 'product_description'}>Product Description</option>
              <option value="blog" selected={post?.postType === 'blog'}>Blog Post</option>
            </select>
          </div>

          {/* Slug */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <label for="slug" class="block text-sm font-medium text-gray-300 mb-2">
              Slug
            </label>
            <input
              type="text"
              id="slug"
              value={post?.slug || ''}
              class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
              placeholder="url-friendly-name"
            />
            <p class="mt-1 text-xs text-gray-500">
              Used in the URL: /your-slug
            </p>
          </div>

          {/* SEO */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <h3 class="text-sm font-medium text-white mb-4">SEO</h3>
            
            <div class="space-y-4">
              <div>
                <label for="meta-title" class="block text-xs font-medium text-gray-400 mb-1">
                  Meta Title
                </label>
                <input
                  type="text"
                  id="meta-title"
                  value={post?.metaTitle || ''}
                  class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
                  placeholder="SEO title..."
                />
              </div>
              
              <div>
                <label for="meta-description" class="block text-xs font-medium text-gray-400 mb-1">
                  Meta Description
                </label>
                <textarea
                  id="meta-description"
                  rows={2}
                  class="w-full px-3 py-2 bg-[#222] border border-[#444] rounded-md text-sm text-white placeholder-gray-500 focus:ring-2 focus:ring-white/20 focus:border-white/30"
                  placeholder="SEO description..."
                >{post?.metaDescription || ''}</textarea>
              </div>
            </div>
          </div>

          {/* Featured Media */}
          <div class="bg-[#1a1a1a] p-6 rounded-lg border border-[#333]">
            <h3 class="text-sm font-medium text-white mb-4">Featured Media</h3>
            
            <div id="featured-media-preview" class="mb-4">
              {post?.media?.filter(m => m.context === 'featured').map(m => (
                <div class="relative aspect-video bg-[#222] rounded-md overflow-hidden">
                  <img 
                    src={m.media.url} 
                    alt={m.media.altText || ''}
                    class="w-full h-full object-cover"
                  />
                  <button
                    type="button"
                    class="absolute top-2 right-2 p-1 bg-red-600 text-white rounded-full hover:bg-red-700"
                    onclick="removeFeaturedMedia()"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              ))}
              
              {!post?.media?.some(m => m.context === 'featured') && (
                <button
                  type="button"
                  id="select-media-btn"
                  class="w-full py-8 border-2 border-dashed border-[#444] rounded-md text-gray-500 hover:border-gray-400 hover:text-gray-400 transition-colors"
                >
                  <svg class="mx-auto h-8 w-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Select Featured Image
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script define:vars={{ postId: post?.id, isEditing }}>
    // Form state
    const state = {
      id: postId,
      title: '',
      slug: '',
      content: '',
      excerpt: '',
      status: 'draft',
      postType: 'page',
      metaTitle: '',
      metaDescription: '',
      mediaIds: [],
      meta: {},
    };

    // Get form values
    function updateStateFromForm() {
      state.title = document.getElementById('title').value;
      state.slug = document.getElementById('slug').value;
      state.content = document.getElementById('content').value;
      state.excerpt = document.getElementById('excerpt').value;
      state.status = document.getElementById('status').value;
      state.postType = document.getElementById('post-type').value;
      state.metaTitle = document.getElementById('meta-title').value;
      state.metaDescription = document.getElementById('meta-description').value;
    }

    // Auto-generate slug from title
    document.getElementById('title').addEventListener('input', (e) => {
      const slugInput = document.getElementById('slug');
      if (!slugInput.value || slugInput.dataset.auto === 'true') {
        slugInput.value = e.target.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        slugInput.dataset.auto = 'true';
      }
    });

    document.getElementById('slug').addEventListener('input', () => {
      document.getElementById('slug').dataset.auto = 'false';
    });

    // Save draft
    document.getElementById('save-draft-btn').addEventListener('click', async () => {
      updateStateFromForm();
      await savePost({ ...state, status: 'draft' });
    });

    // Publish
    document.getElementById('publish-btn').addEventListener('click', async () => {
      updateStateFromForm();
      const status = isEditing && document.getElementById('status').value === 'published' 
        ? 'published' 
        : 'published';
      await savePost({ ...state, status });
    });

    // Save post function
    async function savePost(data) {
      try {
        const url = '/api/admin/posts';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          if (!isEditing && result.post?.id) {
            // Redirect to edit page for new posts
            window.location.href = `/admin/posts/edit?id=${result.post.id}`;
          } else {
            alert('Post saved successfully!');
          }
        } else {
          alert(result.error || 'Failed to save post');
        }
      } catch (err) {
        console.error('Error saving post:', err);
        alert('Failed to save post');
      }
    }

    // Media selection (placeholder - would open media library modal)
    document.getElementById('select-media-btn')?.addEventListener('click', () => {
      alert('Media library coming soon! For now, upload via Media page.');
    });
  </script>
</AdminLayout>
