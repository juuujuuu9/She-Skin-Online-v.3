---
export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { checkAdminAuth } from '@lib/admin-auth';
import { generateCsrfToken } from '@lib/csrf';
import { listMedia } from '@lib/upload-service';

// Generate and set CSRF token
const csrf = generateCsrfToken();
Astro.response.headers.set('Set-Cookie', csrf.cookie);

// Check auth
const auth = await checkAdminAuth(Astro.request);
if (!auth.valid) {
  const reason = auth.debug || 'unknown';
  return Astro.redirect(`/admin/login?session=expired&reason=${encodeURIComponent(reason)}`);
}

// Load media from database
const { media: allMedia } = await listMedia({ limit: 100 });

// Group by type
const images = allMedia.filter(m => m.mediaType === 'image');
const audio = allMedia.filter(m => m.mediaType === 'audio');
const video = allMedia.filter(m => m.mediaType === 'video');

// Format helpers
const formatBytes = (bytes: number) => {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1024 / 1024).toFixed(1) + ' MB';
};

const currentPath = Astro.url.pathname;
const adminNavItems = [
  { href: '/admin', label: 'Uploads', icon: 'dashboard' },
  { href: '/admin/media', label: 'Media Library', icon: 'media' },
  { href: '/admin/audio', label: 'ICT★SNU SOUND', icon: 'audio' },
  { href: '/admin/works', label: 'Works', icon: 'works' },
  { href: '/admin/products', label: 'Inventory', icon: 'products' },
];
const iconPaths: Record<string, string> = {
  dashboard: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />`,
  media: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />`,
  audio: `<path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M21.6464 2.23699C21.8707 2.42699 22 2.70606 22 3.00001V16C22 18.2091 20.2091 20 18 20C15.7909 20 14 18.2091 14 16C14 13.7909 15.7909 12 18 12C18.7286 12 19.4117 12.1948 20 12.5351V4.18047L10 5.84713V18L9.99999 18.0032C9.99824 20.2109 8.20806 22 6 22C3.79086 22 2 20.2091 2 18C2 15.7909 3.79086 14 6 14C6.72857 14 7.41165 14.1948 8 14.5351V5.00001C8 4.51117 8.35341 4.09398 8.8356 4.01361L20.8356 2.01361C21.1256 1.96529 21.4221 2.04698 21.6464 2.23699ZM20 16C20 14.8954 19.1046 14 18 14C16.8954 14 16 14.8954 16 16C16 17.1046 16.8954 18 18 18C19.1046 18 20 17.1046 20 16ZM6 16C7.10457 16 8 16.8954 8 18C8 19.1046 7.10457 20 6 20C4.89543 20 4 19.1046 4 18C4 16.8954 4.89543 16 6 16Z" />`,
  works: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />`,
  products: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />`,
};
const isActive = (href: string) => {
  if (href === '/admin') return currentPath === '/admin' || currentPath === '/admin/';
  return currentPath.startsWith(href);
};
---

<Layout title="Uploads - she_skin Admin">
  <style>
    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <div class="h-dvh bg-[#0a0a0a] flex flex-col overflow-hidden">
    <div class="flex flex-row flex-1 min-h-0 items-stretch">
      {/* Admin sidebar */}
      <aside class="w-64 shrink-0 flex flex-col bg-[#0a0a0a] text-white self-stretch border-r border-white/10">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
          <a href="/admin" class="text-lg font-bold tracking-tight text-white hover:text-white/90">
            she_skin
          </a>
          <button
            type="button"
            id="admin-logout-btn"
            class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs font-medium text-white/70 hover:bg-red-500/20 hover:text-red-400 transition-colors uppercase tracking-wider"
          >
            <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
          </button>
        </div>
        <nav class="flex-1 p-3 min-h-0 overflow-auto" id="admin-nav">
          <ul class="space-y-0.5">
            {adminNavItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  data-nav-link
                  class={`
                    flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium transition-colors
                    ${isActive(item.href) ? 'bg-white text-black' : 'text-white/80 hover:bg-white/10 hover:text-white'}
                  `}
                >
                  <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={iconPaths[item.icon] ?? ''} />
                  <span>{item.label}</span>
                </a>
              </li>
            ))}
          </ul>
        </nav>
        <div class="mx-3 border-t border-white/10" />
        <nav class="p-3" id="admin-view-site">
          <ul class="space-y-0.5">
            <li>
              <a
                href="/"
                data-nav-link
                class="flex items-center gap-3 px-3 py-2.5 rounded-md text-sm text-white/60 hover:bg-white/10 hover:text-white transition-colors"
              >
                <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>View Site</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      {/* Main content */}
      <main class="flex-1 min-w-0 bg-[#111] overflow-y-auto">
        <div class="p-6 max-w-7xl mx-auto">
          <header class="mb-6 flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-semibold text-white">Uploads</h1>
              <p class="text-gray-400 mt-1">Upload files to the Media Library</p>
            </div>
            <a href="/admin/media" class="text-sm text-blue-400 hover:text-blue-300">
              View Full Media Library →
            </a>
          </header>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Upload Area */}
            <div class="lg:col-span-1">
              <div class="bg-[#1a1a1a] rounded-xl border border-[#333] p-6">
                <h2 class="text-lg font-medium text-white mb-4">Upload Files</h2>
                <div
                  id="dashboard-dropzone"
                  class="border-2 border-dashed border-[#444] rounded-lg p-8 text-center transition-colors hover:border-[#666] hover:bg-[#222] flex flex-col items-center justify-center min-h-[200px]"
                >
                  <input
                    type="file"
                    id="dashboard-file-input"
                    class="absolute w-0 h-0 opacity-0"
                    accept="image/*,audio/*,video/*"
                    multiple
                  />
                  <label for="dashboard-file-input" class="cursor-pointer flex flex-col items-center justify-center w-full h-full">
                    <svg class="w-12 h-12 text-[#666] mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="text-gray-400 font-medium">Drag & drop files here</p>
                    <p class="text-sm text-gray-600 mt-1">or click to browse</p>
                    <p class="text-xs text-gray-500 mt-3">Images, Audio, Video • Max 500MB</p>
                  </label>
                </div>
                <div id="dashboard-upload-feedback" class="hidden mt-3 text-sm"></div>
              </div>

              {/* Stats */}
              <div class="bg-[#1a1a1a] rounded-xl border border-[#333] p-4 mt-4">
                <div class="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <div class="text-2xl font-semibold text-white">{images.length}</div>
                    <div class="text-xs text-gray-500 uppercase">Images</div>
                  </div>
                  <div>
                    <div class="text-2xl font-semibold text-white">{audio.length}</div>
                    <div class="text-xs text-gray-500 uppercase">Audio</div>
                  </div>
                  <div>
                    <div class="text-2xl font-semibold text-white">{video.length}</div>
                    <div class="text-xs text-gray-500 uppercase">Video</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Recent Media */}
            <div class="lg:col-span-2">
              <div class="bg-[#1a1a1a] rounded-xl border border-[#333] p-6 relative">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-lg font-medium text-white">Recent Uploads</h2>
                  <label class="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" id="select-all-recent" class="w-4 h-4 accent-blue-500">
                    <span class="text-sm text-gray-400">Select All</span>
                  </label>
                </div>

                {/* Bulk actions bar */}
                <div id="bulk-actions-bar" class="mb-4 p-3 bg-[#1a3a5c] rounded-lg border border-[#2a5a8c] items-center justify-between" style="display: none;">
                  <span id="bulk-actions-text" class="text-sm text-white font-medium">0 items selected</span>
                  <div class="flex items-center gap-2">
                    <button id="bulk-cancel-btn" class="px-3 py-1.5 text-sm text-white border border-gray-500 rounded hover:bg-gray-700 transition-colors">
                      Cancel
                    </button>
                    <button id="bulk-delete-btn" class="px-3 py-1.5 text-sm text-white bg-red-500 hover:bg-red-600 rounded transition-colors">
                      Delete Selected
                    </button>
                  </div>
                </div>

                {/* Upload Spinner Overlay */}
                <div id="upload-spinner-overlay" class="absolute inset-0 bg-[#1a1a1a]/90 z-50 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 rounded-xl">
                  <div class="w-12 h-12 border-4 border-[#333] border-t-[#4a9eff] rounded-full animate-spin mb-4"></div>
                  <p class="text-white font-medium mb-2">Uploading...</p>
                  <p class="text-sm text-gray-400">Don't close this page until upload completes</p>
                  <p id="upload-spinner-file" class="text-xs text-gray-500 mt-2 max-w-[80%] text-center truncate"></p>
                </div>

                {allMedia.length === 0 ? (
                  <div id="media-empty-state" class="text-center py-12">
                    <svg class="w-16 h-16 text-[#333] mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-gray-400">No media yet</p>
                    <p class="text-sm text-gray-500 mt-1">Upload files to see them here</p>
                  </div>
                ) : (
                  <div id="media-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    {allMedia.slice(0, 12).map((item) => (
                      <div class="media-item group relative bg-[#222] rounded-lg overflow-hidden border border-[#333] hover:border-[#555] transition-all" data-id={item.id}>
                        {/* Thumbnail */}
                        <div class="aspect-square relative bg-[#1a1a1a] flex items-center justify-center overflow-hidden">
                          {item.mediaType === 'image' ? (
                            <img
                              src={item.variants?.sm?.url || item.url}
                              alt={item.originalName}
                              class="w-full h-full object-cover"
                              loading="lazy"
                            />
                          ) : item.mediaType === 'audio' ? (
                            <div class="flex flex-col items-center justify-center text-[#666]">
                              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                              </svg>
                              <span class="text-xs mt-2">Audio</span>
                            </div>
                          ) : (
                            <div class="flex flex-col items-center justify-center text-[#666]">
                              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                              <span class="text-xs mt-2">Video</span>
                            </div>
                          )}

                          {/* Checkbox for selection */}
                          <label class="media-checkbox absolute top-2 right-2 p-1 bg-black/50 rounded cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                            <input type="checkbox" class="media-select w-5 h-5 accent-blue-500" data-id={item.id}>
                          </label>

                          {/* Delete button */}
                          <button
                            class="delete-btn absolute bottom-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-all"
                            data-id={item.id}
                            title="Delete"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          </button>

                          {/* Type badge */}
                          <span class="absolute top-2 left-2 text-xs text-white bg-black/50 px-2 py-0.5 rounded uppercase">
                            {item.mediaType}
                          </span>
                        </div>

                        {/* Info */}
                        <div class="p-3">
                          <p class="text-sm text-white truncate" title={item.originalName}>{item.originalName}</p>
                          <p class="text-xs text-gray-500 mt-1">{formatBytes(item.fileSize)}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {allMedia.length > 12 && (
                  <div class="mt-4 text-center">
                    <a href="/admin/media" class="text-sm text-blue-400 hover:text-blue-300">
                      View all {allMedia.length} items →
                    </a>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Navigation
    document.querySelectorAll('a[data-nav-link]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = link.getAttribute('href') || '/';
      });
    });

    document.getElementById('admin-logout-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to logout?')) return;
      try {
        const res = await fetch('/api/admin/logout', { method: 'POST', credentials: 'include' });
        if (res.ok) window.location.href = '/admin/login?logged_out=1';
        else window.location.href = '/admin/login?session=expired';
      } catch {
        alert('Logout failed');
      }
    });

    // Upload
    const dropzone = document.getElementById('dashboard-dropzone');
    const fileInput = document.getElementById('dashboard-file-input') as HTMLInputElement;
    const feedback = document.getElementById('dashboard-upload-feedback');

    if (dropzone && fileInput) {
      // Drag and drop handlers (click is handled natively by the label)
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-[#666]', 'bg-[#222]');
      });
      dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-[#666]', 'bg-[#222]');
      });
      dropzone.addEventListener('drop', (e: DragEvent) => {
        e.preventDefault();
        dropzone.classList.remove('border-[#666]', 'bg-[#222]');
        if (e.dataTransfer?.files && e.dataTransfer.files.length > 0) {
          handleFiles(Array.from(e.dataTransfer.files));
        }
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length > 0) {
          // Copy files to array before async processing
          const filesArray = Array.from(fileInput.files);
          handleFiles(filesArray);
        }
      });
    }

    function uploadFileWithProgress(file: File, onProgress: (percent: number) => void): Promise<any> {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const formData = new FormData();
        formData.append('file', file);

        xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            onProgress(percentComplete);
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const data = JSON.parse(xhr.responseText);
              resolve(data.media);
            } catch {
              resolve(null);
            }
          } else if (xhr.status === 401) {
            window.location.href = '/admin/login?session=expired';
            reject(new Error('Session expired'));
          } else {
            reject(new Error('Upload failed'));
          }
        });

        xhr.addEventListener('error', () => reject(new Error('Network error')));
        xhr.addEventListener('abort', () => reject(new Error('Upload aborted')));

        xhr.open('POST', '/api/admin/media/upload', true);
        xhr.setRequestHeader('X-CSRF-Token', document.cookie.match(/csrf_token=([^;]+)/)?.[1] || '');
        xhr.withCredentials = true;
        xhr.send(formData);
      });
    }

    // Helper to format bytes
    function formatBytes(bytes: number): string {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    }

    // Create media item HTML
    function createMediaItemElement(item: any): HTMLElement {
      const div = document.createElement('div');
      div.className = 'media-item group relative bg-[#222] rounded-lg overflow-hidden border border-[#333] hover:border-[#555] transition-all';
      div.setAttribute('data-id', item.id);

      let thumbnailHtml = '';
      if (item.mediaType === 'image') {
        thumbnailHtml = `<img src="${item.variants?.sm?.url || item.url}" alt="${item.originalName}" class="w-full h-full object-cover" loading="lazy" />`;
      } else if (item.mediaType === 'audio') {
        thumbnailHtml = `<div class="flex flex-col items-center justify-center text-[#666]"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg><span class="text-xs mt-2">Audio</span></div>`;
      } else {
        thumbnailHtml = `<div class="flex flex-col items-center justify-center text-[#666]"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span class="text-xs mt-2">Video</span></div>`;
      }

      div.innerHTML = `
        <div class="aspect-square relative bg-[#1a1a1a] flex items-center justify-center overflow-hidden">
          ${thumbnailHtml}
          <label class="media-checkbox absolute top-2 right-2 p-1 bg-black/50 rounded cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
            <input type="checkbox" class="media-select w-5 h-5 accent-blue-500" data-id="${item.id}">
          </label>
          <button class="delete-btn absolute bottom-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-all" data-id="${item.id}" title="Delete">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
          <span class="absolute top-2 left-2 text-xs text-white bg-black/50 px-2 py-0.5 rounded uppercase">${item.mediaType}</span>
        </div>
        <div class="p-3">
          <p class="text-sm text-white truncate" title="${item.originalName}">${item.originalName}</p>
          <p class="text-xs text-gray-500 mt-1">${formatBytes(item.fileSize)}</p>
        </div>
      `;

      // Add event listeners
      const checkbox = div.querySelector('.media-select') as HTMLInputElement;
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          const cb = e.target as HTMLInputElement;
          const id = cb.getAttribute('data-id');
          if (id) {
            if (cb.checked) {
              selectedIds.add(id);
            } else {
              selectedIds.delete(id);
            }
            updateSelectionUI();
          }
        });
      }

      const deleteBtn = div.querySelector('.delete-btn') as HTMLButtonElement;
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = deleteBtn.getAttribute('data-id');
          if (!id || !confirm('Delete this file?')) return;

          const csrfMatch = document.cookie.match(/csrf_token=([^;]+)/);
          const csrfToken = csrfMatch ? csrfMatch[1] : '';

          try {
            const res = await fetch('/api/admin/media/' + id, {
              method: 'DELETE',
              credentials: 'include',
              headers: { 'X-CSRF-Token': csrfToken }
            });

            if (res.ok) {
              div.remove();
            } else if (res.status === 409) {
              const forceDelete = confirm('This file is in use. Delete anyway?');
              if (forceDelete) {
                const forceRes = await fetch('/api/admin/media/' + id + '?force=true', {
                  method: 'DELETE',
                  credentials: 'include',
                  headers: { 'X-CSRF-Token': csrfToken }
                });
                if (forceRes.ok) {
                  div.remove();
                } else {
                  alert('Delete failed');
                }
              }
            } else {
              alert('Delete failed');
            }
          } catch {
            alert('Delete failed');
          }
        });
      }

      return div;
    }

    async function handleFiles(files: File[]) {
      if (!files.length || !feedback) return;

      const spinnerOverlay = document.getElementById('upload-spinner-overlay');
      const spinnerFile = document.getElementById('upload-spinner-file');
      const mediaGrid = document.getElementById('media-grid');

      feedback.classList.remove('hidden');
      const uploadedMedia: any[] = [];
      const failedFiles: string[] = [];

      // Show spinner overlay
      if (spinnerOverlay) {
        spinnerOverlay.classList.remove('opacity-0', 'pointer-events-none');
        spinnerOverlay.classList.add('opacity-100', 'pointer-events-auto');
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Update spinner text
        if (spinnerFile) {
          spinnerFile.textContent = `File ${i + 1} of ${files.length}: ${file.name}`;
        }

        try {
          const media = await uploadFileWithProgress(file, () => {
            // Progress callback - spinner shows indeterminate progress
          });

          if (media) {
            uploadedMedia.push(media);
          }
          feedback.innerHTML = `<span class="text-blue-400">Uploaded: ${file.name}</span>`;
        } catch (e) {
          failedFiles.push(file.name);
          feedback.innerHTML = `<span class="text-red-400">Failed: ${file.name}</span>`;
          // Continue with next file instead of returning
          continue;
        }
      }

      // Hide spinner overlay
      if (spinnerOverlay) {
        spinnerOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        spinnerOverlay.classList.add('opacity-0', 'pointer-events-none');
      }

      // Add uploaded items to the grid
      if (mediaGrid && uploadedMedia.length > 0) {
        // Remove empty state if present
        const emptyState = document.getElementById('media-empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // Add new items to the beginning of the grid
        for (const item of uploadedMedia.reverse()) {
          const itemElement = createMediaItemElement(item);
          itemElement.style.animation = 'fadeInSlide 0.3s ease-out';
          mediaGrid.insertBefore(itemElement, mediaGrid.firstChild);
        }

        // Update stats
        updateStats();
      }

      // Show appropriate completion message
      if (failedFiles.length > 0) {
        if (failedFiles.length === files.length) {
          feedback.innerHTML = `<span class="text-red-400">All uploads failed</span>`;
        } else {
          feedback.innerHTML = `<span class="text-yellow-400">${uploadedMedia.length} uploaded, ${failedFiles.length} failed</span>`;
        }
      } else {
        feedback.innerHTML = `<span class="text-green-400">${uploadedMedia.length} file(s) uploaded!</span>`;
      }

      // Clear file input after all uploads complete
      if (fileInput) {
        fileInput.value = '';
      }
    }

    // Update stats counters
    function updateStats() {
      const grid = document.getElementById('media-grid');
      if (!grid) return;

      const items = grid.querySelectorAll('.media-item');
      let images = 0, audio = 0, video = 0;

      items.forEach((item) => {
        const typeBadge = item.querySelector('.aspect-square span.uppercase');
        if (typeBadge) {
          const type = typeBadge.textContent?.toLowerCase() || '';
          if (type === 'image') images++;
          else if (type === 'audio') audio++;
          else if (type === 'video') video++;
        }
      });

      // Update stat display if exists
      const statContainer = document.querySelector('.grid.grid-cols-3');
      if (statContainer) {
        const counts = statContainer.querySelectorAll('.text-2xl');
        if (counts.length >= 3) {
          counts[0].textContent = String(images);
          counts[1].textContent = String(audio);
          counts[2].textContent = String(video);
        }
      }
    }

    // Multi-select functionality
    const selectedIds = new Set<string>();
    const selectAllCheckbox = document.getElementById('select-all-recent') as HTMLInputElement;
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const bulkActionsText = document.getElementById('bulk-actions-text');
    const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const mediaGrid = document.getElementById('media-grid');

    function updateSelectionUI() {
      // Update checkboxes
      document.querySelectorAll('.media-select').forEach((checkbox) => {
        const cb = checkbox as HTMLInputElement;
        const id = cb.getAttribute('data-id');
        cb.checked = id ? selectedIds.has(id) : false;
      });

      // Update select all checkbox
      if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.media-select');
        if (selectedIds.size === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (selectedIds.size === allCheckboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }

      // Update bulk actions bar
      if (bulkActionsBar && bulkActionsText) {
        if (selectedIds.size > 0) {
          bulkActionsBar.style.display = 'flex';
          bulkActionsText.textContent = `${selectedIds.size} item${selectedIds.size === 1 ? '' : 's'} selected`;
        } else {
          bulkActionsBar.style.display = 'none';
        }
      }

      // Update visual selection state on items
      document.querySelectorAll('.media-item').forEach((item) => {
        const id = item.getAttribute('data-id');
        if (id && selectedIds.has(id)) {
          item.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
          item.classList.remove('border-[#333]');
          item.classList.add('border-blue-500');
        } else {
          item.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50', 'border-blue-500');
          item.classList.add('border-[#333]');
        }
      });

      // Always show checkboxes when in selection mode
      document.querySelectorAll('.media-checkbox').forEach((cb) => {
        if (selectedIds.size > 0) {
          cb.classList.remove('opacity-0');
          cb.classList.add('opacity-100');
        } else {
          cb.classList.add('opacity-0');
          cb.classList.remove('opacity-100');
        }
      });
    }

    // Individual item selection
    document.querySelectorAll('.media-select').forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        const cb = e.target as HTMLInputElement;
        const id = cb.getAttribute('data-id');
        if (id) {
          if (cb.checked) {
            selectedIds.add(id);
          } else {
            selectedIds.delete(id);
          }
          updateSelectionUI();
        }
      });
    });

    // Select all checkbox
    selectAllCheckbox?.addEventListener('change', () => {
      if (selectAllCheckbox.checked) {
        document.querySelectorAll('.media-select').forEach((checkbox) => {
          const id = checkbox.getAttribute('data-id');
          if (id) selectedIds.add(id);
        });
      } else {
        selectedIds.clear();
      }
      updateSelectionUI();
    });

    // Cancel selection
    bulkCancelBtn?.addEventListener('click', () => {
      selectedIds.clear();
      updateSelectionUI();
    });

    // Bulk delete
    bulkDeleteBtn?.addEventListener('click', async () => {
      if (selectedIds.size === 0) return;

      const confirmed = confirm(`Delete ${selectedIds.size} selected item${selectedIds.size === 1 ? '' : 's'}?`);
      if (!confirmed) return;

      const forceDelete = confirm('Items that are in use will not be deleted. Click OK to force delete all items anyway.');

      const csrfMatch = document.cookie.match(/csrf_token=([^;]+)/);
      const csrfToken = csrfMatch ? csrfMatch[1] : '';

      let deletedCount = 0;
      let failedCount = 0;

      for (const id of selectedIds) {
        try {
          const res = await fetch(`/api/admin/media/${id}?force=${forceDelete}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'X-CSRF-Token': csrfToken }
          });

          if (res.ok) {
            deletedCount++;
            // Remove the item from the DOM
            const item = document.querySelector(`.media-item[data-id="${id}"]`);
            item?.remove();
          } else if (res.status === 409) {
            // Item is in use
            failedCount++;
          } else {
            failedCount++;
          }
        } catch {
          failedCount++;
        }
      }

      selectedIds.clear();
      updateSelectionUI();

      if (failedCount > 0) {
        alert(`${deletedCount} item(s) deleted. ${failedCount} item(s) could not be deleted (may be in use).`);
      } else {
        // Show success feedback
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        successMsg.textContent = `${deletedCount} item(s) deleted successfully`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      }
    });

    // Individual delete
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = btn.getAttribute('data-id');
        if (!id || !confirm('Delete this file?')) return;

        const csrfMatch = document.cookie.match(/csrf_token=([^;]+)/);
        const csrfToken = csrfMatch ? csrfMatch[1] : '';

        try {
          const res = await fetch(`/api/admin/media/${id}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'X-CSRF-Token': csrfToken }
          });

          if (res.ok) {
            const card = btn.closest('.media-item');
            card?.remove();
          } else if (res.status === 409) {
            const forceDelete = confirm('This file is in use. Delete anyway?');
            if (forceDelete) {
              const forceRes = await fetch(`/api/admin/media/${id}?force=true`, {
                method: 'DELETE',
                credentials: 'include',
                headers: { 'X-CSRF-Token': csrfToken }
              });
              if (forceRes.ok) {
                const card = btn.closest('.media-item');
                card?.remove();
              } else {
                alert('Delete failed');
              }
            }
          } else {
            alert('Delete failed');
          }
        } catch {
          alert('Delete failed');
        }
      });
    });
  </script>
</Layout>
