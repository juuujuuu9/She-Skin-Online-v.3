---
export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { AudioGrid } from '@components/AudioGrid';
import { AudioGridControls } from '@components/AudioGridControls';
import { getPublishedAudioPosts } from '@lib/db/queries';
import type { Track, Release } from '@lib/audioStore';

// Fetch audio posts from database
const audioPosts = await getPublishedAudioPosts();

// Debug: log what we got
console.log('[Audio Page] Fetched posts:', audioPosts.length);
console.log('[Audio Page] Posts:', audioPosts.map(p => ({ title: p.title, hasAudio: !!p.audioFile, audioUrl: p.audioFile?.slice(0, 50) })));

// Transform database posts to Release/Track format
const releases: Release[] = audioPosts.map((post) => {
  const year = post.publishedAt?.getFullYear() || new Date().getFullYear();
  
  // Build track from audio file if available
  const tracks: Track[] = [];
  
  if (post.audioFile) {
    tracks.push({
      id: post.slug,
      title: post.title,
      artist: 'she_skin',
      src: post.audioFile,
      coverArt: post.artwork || undefined,
      album: post.title,
      year,
      youtubeLink: post.youtubeLink,
      soundcloudLink: post.soundcloudLink,
    });
  }
  
  return {
    id: post.id,
    title: post.title,
    year,
    coverArt: post.artwork,
    tracks,
    youtubeLink: post.youtubeLink,
    soundcloudLink: post.soundcloudLink,
  };
});

// Filter out releases with no playable tracks (unless they have external links)
// For now, we show all - empty tracks array just means no direct audio
const playableReleases = releases;
---

<Layout title="ICT★SNU SOUND - she_skin">
  <main class="min-h-screen bg-white">
    <header class="px-6 pt-16">
      <div class="w-full flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h1 class="sm:text-2xl text-[13px] font-bold tracking-tight text-black mb-4">
            ICT★SNU SOUND
          </h1>
          <p class="text-sm text-gray-500 max-w-xl">
            Audio releases and sound works. Click play to begin listening — the player will persist as you navigate.
          </p>
        </div>
        <div class="w-12 shrink-0" aria-hidden="true" />
        <AudioGridControls client:idle />
      </div>
    </header>

    <section class="px-4 sm:px-6 pt-6 pb-12" id="audio-grid-section">
      {playableReleases.length > 0 ? (
        <AudioGrid client:idle releases={playableReleases} />
      ) : (
        <div class="text-center py-20">
          <p class="text-gray-500">No audio releases yet.</p>
          <p class="text-sm text-gray-400 mt-2">
            New releases will appear here when published from the admin panel.
          </p>
        </div>
      )}
    </section>
  </main>
</Layout>
