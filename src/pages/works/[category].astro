---
/**
 * Works Archive — Category-based portfolio grid
 *
 * All categories (audio, physical, digital, collaborations) are served from the database.
 * Routes: /works/audio | /works/physical | /works/digital | /works/collaborations
 */

export const prerender = false;

import LightningImage from '@components/ui/LightningImage.astro';
import Layout from '@layouts/Layout.astro';
import { WorksGrid } from '@components/WorksGrid';
import { WorksGridControls } from '@components/WorksGridControls';
import { getWorksForGrid, type WorkCategory } from '@lib/db/queries';

const { category } = Astro.params;

const validCategories = ['audio', 'physical', 'digital', 'collaborations'] as const;
if (!category || !validCategories.includes(category as (typeof validCategories)[number])) {
  return Astro.redirect('/404');
}

const categoryProp = category as WorkCategory;

// Single source: database for all categories
const gridItems = await getWorksForGrid(categoryProp);

// Category display config
const categoryConfig = {
  audio: {
    title: 'ICT★SNU SOUND',
    subtitle: 'Audio works and music productions',
    layout: 'list' as const,
  },
  physical: {
    title: 'Physical Works',
    subtitle: 'Paintings, sculptures, and physical artifacts',
    layout: 'grid' as const,
  },
  digital: {
    title: 'Digital',
    subtitle: 'Digital art and new media',
    layout: 'grid' as const,
  },
  collaborations: {
    title: 'Collaborations',
    subtitle: 'Projects with other artists and collectives',
    layout: 'grid' as const,
  },
};

const config = categoryConfig[categoryProp];

// All categories use the adjustable grid; audio uses list layout in the template below
const useWorksGrid = true;

// Map to WorksGrid shape (slug, title, year, forSale, image, href). Variants from DB may be { url, width } or URL strings; normalize to grid shape.
function toGridItem(item: typeof gridItems[number]) {
  const img = item.image;
  let variants: { sm?: { url: string; width: number }; md?: { url: string; width: number }; lg?: { url: string; width: number } } | undefined;
  if (img?.variants && typeof img.variants === 'object') {
    const v = img.variants as Record<string, unknown>;
    if (v.sm && typeof v.sm === 'object' && v.sm !== null && 'url' in v.sm) {
      variants = {
        sm: (v.sm as { url: string; width: number }),
        md: (v.md as { url: string; width: number }) ?? undefined,
        lg: (v.lg as { url: string; width: number }) ?? undefined,
      };
    }
  }
  return {
    slug: item.slug,
    title: item.title,
    year: item.year ?? undefined,
    forSale: item.forSale,
    image: img
      ? {
          src: img.src,
          alt: img.alt,
          width: img.width ?? undefined,
          height: img.height ?? undefined,
          variants,
          dominantColor: img.dominantColor ?? undefined,
        }
      : null,
    href: item.externalUrl ?? undefined,
  };
}
const worksGridItems = gridItems.map(toGridItem);

// Featured flag not in DB yet; when added we can filter gridItems
const featuredWorks: typeof gridItems = [];
---

<Layout title={`${config.title} - she_skin`}>
  <main class="min-h-screen bg-white">
    {/* Header */}
    <header class="px-6 pt-16">
      <div class="w-full flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h1 class="sm:text-2xl text-[13px] font-bold tracking-tight text-black mb-4">
            {config.title}
          </h1>
          <p class="text-sm text-gray-500 max-w-xl">
            {config.subtitle}
          </p>
        </div>
        {useWorksGrid ? <div class="w-12 shrink-0" aria-hidden="true" /> : null}
        {useWorksGrid && (
          <WorksGridControls
            client:idle
            defaultColsDesktop={
              categoryProp === 'digital' ? 3
              : categoryProp === 'physical' ? 5
              : categoryProp === 'collaborations' ? 3
              : undefined
            }
            defaultColsMobile={categoryProp === 'collaborations' ? 1 : categoryProp === 'digital' || categoryProp === 'physical' ? 3 : undefined}
          />
        )}
      </div>
    </header>

    {/* Featured Works (when featured flag exists in DB) */}
    {featuredWorks.length > 0 && (
      <section class="px-6 pt-6 pb-12 bg-gray-50">
        <div class="w-full">
          <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-8">
            Featured
          </h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
            {featuredWorks.map((work) => (
              <a
                href={work.externalUrl || `/works/${categoryProp}/${work.slug}`}
                class="group block bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow"
              >
                {work.image && (
                  <div class="overflow-hidden">
                    <LightningImage
                      src={work.image.src}
                      alt={work.image.alt}
                      variants={work.image.variants as unknown}
                      blurhash={work.image.blurhash ?? undefined}
                      dominantColor={work.image.dominantColor ?? undefined}
                      width={work.image.width ?? undefined}
                      height={work.image.height ?? undefined}
                      aspectRatio={work.image.width && work.image.height ? work.image.width / work.image.height : undefined}
                      objectFit="contain"
                      sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                      priority={true}
                      class="group-hover:scale-105 transition-transform duration-500"
                    />
                  </div>
                )}
                <div class="p-6">
                  <h3 class="text-xl font-semibold text-gray-900 group-hover:text-gray-700">
                    {work.title}
                  </h3>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    {/* Main Grid */}
    <section class="px-6 pt-6 pb-12">
      <div class="w-full">
        <WorksGrid
          client:only="react"
          works={worksGridItems}
          titleClassName={categoryProp === 'collaborations' ? 'text-[13px] font-medium text-gray-900 group-hover:text-gray-700 line-clamp-2' : undefined}
          defaultColsDesktop={
            categoryProp === 'digital' ? 3
            : categoryProp === 'physical' ? 5
            : categoryProp === 'collaborations' ? 3
            : undefined
          }
          defaultColsMobile={categoryProp === 'collaborations' ? 1 : categoryProp === 'digital' || categoryProp === 'physical' ? 3 : undefined}
          alignRowsCenter={categoryProp === 'digital' || categoryProp === 'physical' || categoryProp === 'collaborations'}
          basePath={`/works/${categoryProp}`}
        />
      </div>
    </section>

    {/* Empty State */}
    {worksGridItems.length === 0 && (
      <div class="px-6 py-20 text-center">
        <p class="text-gray-500">No works in this category yet.</p>
      </div>
    )}
  </main>
</Layout>
